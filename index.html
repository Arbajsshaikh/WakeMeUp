<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Travel Alarm Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>

<body>

<div class="app-frame">

  <!-- ===== HEADER BAR ===== -->


  <!-- ===== PURPLE INFO CARD ===== -->
  <div class="top-card">

    <div class="top-header">

  <div class="top-left">
    <div class="app-title">

  <div class="title-row">
      <div class="main-title">Wake Me Up</div>

      <div id="infoBtn" class="info-btn">i</div>
        <div id="refreshBtn" class="info-btn">R</div>

  </div>

  <div class="tagline">Smart Location Alarms For Travelers</div>

</div>


  </div>

  <div class="top-right">
    <span id="distanceDisplay"></span>
  </div>

</div>


    <div id="stopList" class="stop-list"></div>

    <div class="search-row">
      <input id="searchBox" placeholder="Search city">
      <button id="searchBtn">Search</button>
    </div>

    <button id="addStopBtn">+ Add Stop</button>

    <div class="radius-row">
      <div>Radius (km)</div>
      <input type="number" id="radiusInput" value="0.5" step="0.1">
    </div>

    <input type="range"
           id="radiusSlider"
           min="100"
           max="20000"
           step="100"
           value="500">

  </div>


  <!-- ===== WHITE MAP CONTAINER ===== -->
  <div class="map-shell">

      <!-- MAP PREVIEW -->
      <div class="map-card">
        <div class="map-inner">
          <div id="map"></div>
        </div>
      </div>

      <!-- SLIDER INSIDE SAME CARD -->
      <div class="slider-container">

        <div class="alarm-slider" id="alarmSlider">
          <div class="slider-track">
            <span class="slider-text">
              SLIDE TO ACTIVATE ALARM
            </span>
            <div class="slider-thumb" id="sliderThumb"></div>
          </div>
        </div>

      </div>

  </div>

</div>




<style> 



#refreshBtn{
  background:#ffffff;
  color:#6a52ff;
  size:15px;
}


/* ===== APPLE STYLE REFRESH EFFECT ===== */
#refreshOverlay{
  position:fixed;
  top:50%;
  left:50%;
  width:20px;
  height:20px;
  border-radius:50%;
  background:radial-gradient(circle,
    rgba(149, 255, 110, 0.6),
    rgba(118,110,255,0.2),
    transparent);

  transform:translate(-50%,-50%) scale(0);
  pointer-events:none;
  z-index:99999;
  opacity:0;
}

#refreshOverlay.active{
  animation:pairPulse 0.9s ease forwards;
}

@keyframes pairPulse{
  0%{
    transform:translate(-50%,-50%) scale(0);
    opacity:1;
  }

  70%{
    transform:translate(-50%,-50%) scale(25);
    opacity:0.8;
  }

  100%{
    transform:translate(-50%,-50%) scale(40);
    opacity:0;
  }
}

.pulse-marker{
  width:18px;
  height:18px;
  border-radius:50%;
  background:#00ff88;
  box-shadow:0 0 0 rgba(0,255,120,0.6);
  animation:pulseAnim 1.5s infinite;
}

@keyframes pulseAnim{
  0%{box-shadow:0 0 0 0 rgba(0,255,120,.6);}
  70%{box-shadow:0 0 0 18px rgba(0,255,120,0);}
  100%{box-shadow:0 0 0 0 rgba(0,255,120,0);}
}

/* TITLE ROW */
.title-row{
    display:flex;
    align-items:center;
    gap:8px;
}

/* INFO ICON */
.info-btn{
    width:18px;
    height:18px;
    margin-left:10px;
    border-radius:50%;
    background:white;
    color:#6a52ff;
    font-weight:bold;
    font-size:19px;

    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;

    box-shadow:0 3px 8px rgba(0,0,0,.2);

    /* INFINITE PREMIUM POP */
    animation:popPulse 1.2s ease-in-out infinite;
}

/* ===== PREMIUM POP IN-OUT ===== */
@keyframes popPulse{

    0%{
        transform:scale(1);
        box-shadow:0 3px 8px rgba(0,0,0,.2);
        opacity:1;
    }

    50%{
        transform:scale(1.25);
        box-shadow:0 0 14px rgba(106,82,255,.6);
        opacity:0.85;
    }

    100%{
        transform:scale(1);
        box-shadow:0 3px 8px rgba(0,0,0,.2);
        opacity:1;
    }
}


/* OVERLAY */
.guide-modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.35);
    backdrop-filter:blur(3px);
    z-index:9999;
}

/* BEAUTIFUL GUIDE CARD */
.guide-box{
    width:88%;
    max-width:370px;
    background:#ffffff;
    border-radius:24px;
    padding:18px;

    /* SOFT SHADOW */
    box-shadow:
      0 15px 35px rgba(0,0,0,0.22),
      0 0 0 2px rgba(130,95,255,0.25),
      0 0 20px rgba(120,80,255,0.35);

    animation:guidePop .35s ease;
}

/* POP EFFECT */
@keyframes guidePop{
    from{
      transform:scale(0.85) translateY(20px);
      opacity:0;
    }
    to{
      transform:scale(1);
      opacity:1;
    }
}

/* HEADER */
.guide-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
}

.guide-title{
    font-size:20px;
    font-weight:700;
    color:#3b2bbf;
}

/* CLOSE BUTTON */
#closeGuide{
    border:none;
    width:30px;
    height:30px;
    border-radius:50%;
    background:#ffffff;
    color:#6a52ff;
    font-size:16px;
    cursor:pointer;
    transition:.2s;
}

#closeGuide:hover{
    transform:scale(1.1);
}

/* CONTENT */
.guide-content{
    font-size:14px;
    line-height:1.6;
    color:#333;
}

.guide-section-title{
    font-weight:700;
    color:#5a44ff;
    margin-top:10px;
    margin-bottom:6px;
}


    /* ================= GLOBAL ================= */
*{box-sizing:border-box;}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  display:flex;
  justify-content:center;
  overflow:auto;

  background:
    radial-gradient(circle at var(--x,50%) var(--y,0%),
    #ffffff,#eef0ff 45%,#e5e7f3);
}
.app-title{
  display:flex;
  flex-direction:column;
  line-height:1.2;
}

.main-title{
  font-size:17px;
  font-weight:700;
  color:white;
  letter-spacing:.2px;
  text-shadow:0 2px 6px rgba(255,255,255,.35);
}

.tagline{
  font-size:11px;
  font-weight:500;
  opacity:.85;
  color:white;
}
.app-title{
  margin-top:-2px;
}

/* ================= APP FRAME ================= */
.app-frame{
  width:100%;
  max-width:420px;
  height:100vh;
  padding:10px;
  position:relative;
  overflow:hidden;

  filter:drop-shadow(0 25px 55px rgba(0,0,0,.18));
}

/* ================= PURPLE CARD ================= */
.top-card{
  margin-top:8px;
  background:linear-gradient(135deg,#766eff,#5c40db);
  border-radius:28px;
  padding:16px;
  color:white;

  box-shadow:
    0 20px 40px rgba(92,64,219,.45),
    inset 0 2px 4px rgba(255,255,255,.35);

  animation:cardFloat 4s ease-in-out infinite;
}

@keyframes cardFloat{
  0%,100%{transform:translateY(0);}
  50%{transform:translateY(-2px);}
}

/* ===== TOP HEADER ===== */
.top-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.white-dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:white;
  box-shadow:0 0 12px rgba(255,255,255,.9);
}

.top-right{
  font-size:13px;
  font-weight:700;
  color:white;
  text-shadow:0 2px 6px rgba(255,255,255,.4);
}

/* ================= INPUTS ================= */
.search-row{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.search-row input,
.radius-row input{
  flex:1;
  border:none;
  border-radius:14px;
  padding:12px;
  outline:none;
  background:rgba(255,255,255,.97);

  box-shadow:
    inset 0 2px 5px rgba(0,0,0,.08),
    0 5px 12px rgba(0,0,0,.12);

  transition:.25s;
}

.search-row input:focus,
.radius-row input:focus{
  transform:translateY(-2px) scale(1.02);
  box-shadow:
    0 0 0 3px rgba(255,255,255,.35),
    0 12px 25px rgba(0,0,0,.25);
}

/* ================= BUTTONS ================= */
button{
  width:100%;
  margin-top:8px;
  border:none;
  border-radius:14px;
  padding:10px;
  font-weight:700;
  color:#6f6ce8;
  background:white;
  cursor:pointer;

  transition:.2s;
}

button:active{
  transform:scale(.95);
}

/* ================= RADIUS ================= */
.radius-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:12px;
}

.radius-row input{
  width:90px;
}

input[type=range]{
  width:100%;
  margin-top:8px;
}

/* ================= MAP SHELL ================= */
.map-shell{
  margin-top:12px;
  background:white;
  border-radius:30px;
  padding:10px;
  height:calc(100vh - 285px);

  display:flex;
  flex-direction:column;

  box-shadow:
    0 25px 55px rgba(0,0,0,.18),
    inset 0 1px 3px rgba(255,255,255,.9);

  animation:mapFloat 5s ease-in-out infinite;
}

@keyframes mapFloat{
  0%,100%{transform:translateY(0);}
  50%{transform:translateY(-3px);}
}

/* ================= MAP ================= */
.map-card{
  flex:1;
  background:#ececf3;
  border-radius:22px;
  padding:8px;
}

.map-inner{
  width:100%;
  height:100%;
  border-radius:18px;
  overflow:hidden;

  box-shadow:
    0 15px 35px rgba(0,0,0,.25),
    0 0 20px rgba(111,108,232,.35);
}

#map{
  width:100%;
  height:100%;
}

/* ================= SLIDER ================= */
.slider-container{
  margin-top:10px;
  background:#ececf3;
  border-radius:30px;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.alarm-slider{
  width:100%;
  padding:0 5px;
}

.slider-track{
  position:relative;
  height:70px;
  border-radius:45px;
  background:linear-gradient(135deg,#766eff,#5c40db);

  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;

  box-shadow:
    inset 0 2px 4px rgba(255,255,255,.3),
    0 10px 25px rgba(92,64,219,.55);
}

/* ===== LIVE GRADIENT SHINE ===== */
.slider-track::before{
  content:"";
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,.25),
    transparent
  );
  animation:shine 3s linear infinite;
}

@keyframes shine{
  to{left:100%;}
}

/* ===== ALARM ON PULSE ===== */
.slider-track.active{
  animation:pulse 1.5s infinite;
}

@keyframes pulse{
  0%,100%{box-shadow:0 0 0 rgba(111,108,232,.6);}
  50%{box-shadow:0 0 25px rgba(111,108,232,.85);}
}

/* ===== TEXT ===== */
.slider-text{
  color:white;
  font-weight:700;
  font-size:14px;
  text-shadow:0 2px 6px rgba(0,0,0,.2);
  user-select:none;
}

/* ===== THUMB ===== */
.slider-thumb{
  position:absolute;
  left:0;
  top:50%;
  transform:translateY(-50%);
  width:60px;
  height:60px;
  border-radius:50%;
  background:white;

  box-shadow:
    0 8px 18px rgba(0,0,0,.3),
    0 0 12px rgba(255,255,255,.85);

  cursor:pointer;

  /* üî• smooth but stable */
  transition:left 0.05s linear;
}


/* HAPTIC BOUNCE */
.slider-thumb:active{
  transform:translateY(-50%) scale(1.15);
}

/* ================= TOAST ================= */
.toast{
  position:absolute;
  left:50%;
  bottom:95px;
  transform:translateX(-50%) translateY(20px);

  background:linear-gradient(135deg,#766eff,#5c40db);
  color:white;
  padding:12px 20px;
  border-radius:24px;
  font-size:13px;

  box-shadow:0 12px 25px rgba(0,0,0,.25);

  opacity:0;
  transition:.3s;
  z-index:9999;
}

.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}


/* ================= PREMIUM RADIUS SLIDER ================= */

input[type=range]{
  -webkit-appearance:none;
  width:100%;
  height:8px;
  border-radius:20px;
  outline:none;

  background:linear-gradient(
    90deg,
    #766eff 0%,
    #6f6ce8 50%,
    #5c40db 100%
  );

  box-shadow:
    inset 0 2px 4px rgba(0,0,0,.2),
    0 4px 10px rgba(111,108,232,.4);

  transition:.25s;
}

/* ===== SLIDER HOVER GLOW ===== */
input[type=range]:hover{
  box-shadow:
    inset 0 2px 4px rgba(0,0,0,.25),
    0 0 15px rgba(111,108,232,.65);
}

/* ===== WEBKIT THUMB (Chrome/Edge) ===== */
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:22px;
  height:22px;
  border-radius:50%;
  background:white;
  cursor:pointer;

  box-shadow:
    0 4px 12px rgba(0,0,0,.3),
    0 0 10px rgba(255,255,255,.9);

  transition:.15s;
}

/* HAPTIC EFFECT */
input[type=range]::-webkit-slider-thumb:active{
  transform:scale(1.2);
}

/* ===== FIREFOX ===== */
input[type=range]::-moz-range-thumb{
  width:22px;
  height:22px;
  border:none;
  border-radius:50%;
  background:white;
  cursor:pointer;
  box-shadow:
    0 4px 12px rgba(0,0,0,.3),
    0 0 10px rgba(255,255,255,.9);
}

</style>





<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let routeAbortController = null;
let alarmArmed = false;

// ================= INIT MAP =================
let map = L.map('map').setView([20,77],5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'¬© OpenStreetMap'
}).addTo(map);

let userLatLng;
let userMarker;
let accuracyCircle;
let routeLine;

let finalDestination = null;
let finalMarker = null;
let finalCircle = null;

let stops = [];
let addingStop = false;
let currentRadius = 500;
let routeCoords = [];


let completedRouteLine = null;
let remainingRouteLine = null;

let followUser = true;
let directionArrow = null;


// ================= LIVE LOCATION =================

// ================= LIVE LOCATION =================
navigator.geolocation.watchPosition(

function(pos){

  userLatLng = L.latLng(
    pos.coords.latitude,
    pos.coords.longitude
  );

  const heading = pos.coords.heading;

  if(!userMarker){

    userMarker = L.marker(userLatLng,{
      icon: L.divIcon({
        className:"",
        html:'<div class="pulse-marker"></div>',
        iconSize:[18,18]
      })
    }).addTo(map);

    accuracyCircle = L.circle(userLatLng,{
      radius:pos.coords.accuracy,
      fillOpacity:.15,
      color:"#6f6ce8"
    }).addTo(map);

    map.setView(userLatLng,15);

  }else{

    userMarker.setLatLng(userLatLng);
    accuracyCircle.setLatLng(userLatLng);
    accuracyCircle.setRadius(pos.coords.accuracy);
  }

  // ===== DIRECTION ARROW =====
  if(heading !== null){

    if(!directionArrow){

      directionArrow = L.marker(userLatLng,{
        icon:L.divIcon({
          className:"",
          html:`<div style="
            width:0;height:0;
            border-left:8px solid transparent;
            border-right:8px solid transparent;
            border-bottom:16px solid #00cc66;
            transform:rotate(${heading}deg);
          "></div>`
        })
      }).addTo(map);

    }else{

      directionArrow.setLatLng(userLatLng);

      directionArrow.setIcon(
        L.divIcon({
          className:"",
          html:`<div style="
            width:0;height:0;
            border-left:8px solid transparent;
            border-right:8px solid transparent;
            border-bottom:16px solid #00cc66;
            transform:rotate(${heading}deg);
          "></div>`
        })
      );
    }
  }

  if(followUser){
    map.panTo(userLatLng,{
      animate:true,
      duration:0.8
    });
  }

  checkGeofence();
  updateRemainingDistance();
  updateRouteProgress(); // now valid

},

function(error){
  console.log("GPS Error:", error);
  alert("Please allow location access");
},

{
  enableHighAccuracy:true
}

);


// ================= RADIUS =================
const slider = document.getElementById("radiusSlider");
const radiusInput = document.getElementById("radiusInput");
function searchCity(){

  const city = document.getElementById("searchBox").value.trim();
  if(!city) return;

fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(city)}&limit=1`)
  .then(res=>res.json())
  .then(data=>{

    if(!data.length){
      alert("City not found");
      return;
    }

    const latlng = L.latLng(
      parseFloat(data[0].lat),
      parseFloat(data[0].lon)
    );

    setFinalDestination(latlng);

  })
  .catch(()=>alert("Search failed"));

}


slider.addEventListener("input", function(){

  currentRadius = parseInt(this.value);
  radiusInput.value = (currentRadius / 1000).toFixed(1);

  updateAllCircles();

});

radiusInput.addEventListener("input", function(){

  let km = parseFloat(this.value);
  if(isNaN(km) || km <= 0) return;

  currentRadius = km * 1000;
  slider.value = currentRadius;

  updateAllCircles();

});

function updateAllCircles(){

  // update final destination circle
  if(finalCircle){
    finalCircle.setRadius(currentRadius);
  }

  // update all stop circles
  stops.forEach(stop=>{
    stop.radius = currentRadius;
    stop.circle.setRadius(currentRadius);
  });

}



// ================= SEARCH =================
document.getElementById("searchBox")
.addEventListener("keydown", function(e){

  if(e.key !== "Enter") return;

  const city = this.value.trim();
  if(!city) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`)
    .then(res => res.json())
    .then(data => {

      if(!data.length){
        alert("City not found");
        return;
      }

      const latlng = L.latLng(
        parseFloat(data[0].lat),
        parseFloat(data[0].lon)
      );

      setFinalDestination(latlng);
      drawRoute();   // IMPORTANT

    })
    .catch(err=>{
      console.log("Search error:", err);
      alert("Search failed. Try again.");
    });

});

document.getElementById("searchBtn").onclick = searchCity;

document.getElementById("searchBox")
.addEventListener("keydown",e=>{
  if(e.key==="Enter") searchCity();
});

// ================= ADD STOP MODE =================
document.getElementById("addStopBtn").onclick=function(){
  addingStop=true;
showToast("Click on map to add stop");
};


// ================= MAP CLICK =================
map.on("click",function(e){

  if(!userLatLng){
    alert("Waiting for GPS...");
    return;
  }

  if(addingStop){
    addStop(e.latlng);
    addingStop=false;
  } else {
    setFinalDestination(e.latlng);
  }


});


// ================= FINAL DESTINATION =================
function setFinalDestination(latlng){

  if(finalMarker) map.removeLayer(finalMarker);
  if(finalCircle) map.removeLayer(finalCircle);

  finalDestination=latlng;

  finalMarker=L.marker(latlng).addTo(map);

  finalCircle=L.circle(latlng,{
    radius:currentRadius,
    color:"red",
    fillOpacity:.2
  }).addTo(map);
drawRoute();
resetAlarmSlider();
}


// ================= ADD STOP =================
async function addStop(latlng){

  let marker=L.marker(latlng,{icon:L.icon({
    iconUrl:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
    iconSize:[32,32]
  })}).addTo(map);

  let circle=L.circle(latlng,{
    radius:currentRadius,
    color:"orange",
    fillOpacity:.2
  }).addTo(map);

  const cityName = await getCityName(latlng.lat,latlng.lng);

  const stopObj={
    latlng,
    marker,
    circle,
    radius:currentRadius,
    reached:false,
    name:cityName
  };

  stops.push(stopObj);

  renderStops();
  drawRoute();
  resetAlarmSlider();
}
function renderStops(){

  const container=document.getElementById("stopList");
  container.innerHTML="";

  stops.forEach((stop,index)=>{

    const chip=document.createElement("div");
    chip.className="stop-chip";
    chip.innerHTML=`${stop.name} <span data-id="${index}">‚úï</span>`;

    container.appendChild(chip);

  });

}
document.getElementById("stopList")
.addEventListener("click",e=>{

  if(e.target.tagName==="SPAN"){

    const i=e.target.dataset.id;
    const stop=stops[i];

    map.removeLayer(stop.marker);
    map.removeLayer(stop.circle);

    stops.splice(i,1);

    renderStops();
    drawRoute();
    resetAlarmSlider();

  }

});


// ================= DRAW ROUTE =================
function drawRoute(){

  
  if(!userLatLng || !finalDestination) return;

  // cancel previous request
  if(routeAbortController){
    routeAbortController.abort();
  }
  // ‚≠ê CLEAR ROUTE IMMEDIATELY
  clearRoute();

  routeAbortController = new AbortController();

  


  let coords=`${userLatLng.lng},${userLatLng.lat}`;

  stops.forEach(s=>{
    coords+=`;${s.latlng.lng},${s.latlng.lat}`;
  });

  coords+=`;${finalDestination.lng},${finalDestination.lat}`;

  fetch(
    `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`,
    { signal: routeAbortController.signal }
  )
  .then(res=>res.json())
  .then(data=>{

  if(!data.routes || !data.routes.length) return;

  routeLine = L.geoJSON(data.routes[0].geometry,{
    style:{color:"#6f6ce8",weight:5}
  }).addTo(map);

  map.fitBounds(routeLine.getBounds());
  routeCoords = data.routes[0].geometry.coordinates.map(c =>
  L.latLng(c[1], c[0])
);


  updateDistance();   // ‚úÖ CORRECT PLACE
  
})
}

function updateRouteProgress(){

  if(!userLatLng || routeCoords.length===0) return;

  let nearest = 0;
  let min = Infinity;

  routeCoords.forEach((pt,i)=>{
    const d = userLatLng.distanceTo(pt);
    if(d < min){
      min = d;
      nearest = i;
    }
  });

  const completed = routeCoords.slice(0,nearest+1);
  const remaining = routeCoords.slice(nearest);

  if(completedRouteLine)
    map.removeLayer(completedRouteLine);

  if(remainingRouteLine)
    map.removeLayer(remainingRouteLine);

  completedRouteLine = L.polyline(completed,{
    color:"#999",
    weight:6
  }).addTo(map);

  remainingRouteLine = L.polyline(remaining,{
    color:"#6f6ce8",
    weight:6
  }).addTo(map);

  // distance remaining
  let dist=0;
  for(let i=1;i<remaining.length;i++){
    dist += remaining[i]
      .distanceTo(remaining[i-1]);
  }

  document.getElementById("distanceDisplay")
    .textContent =
    "Distance: "+(dist/1000).toFixed(2)+" km";
}



function clearRoute(){

  if(routeLine){
    map.removeLayer(routeLine);
    routeLine = null;
  }

  if(completedRouteLine){
    map.removeLayer(completedRouteLine);
    completedRouteLine = null;
  }

  if(remainingRouteLine){
    map.removeLayer(remainingRouteLine);
    remainingRouteLine = null;
  }

  routeCoords = [];
}

function updateRemainingDistance(){

  if(!userLatLng || routeCoords.length === 0) return;

  let nearestIndex = 0;
  let minDist = Infinity;

  // find closest route point to user
  routeCoords.forEach((pt,i)=>{
    const d = userLatLng.distanceTo(pt);
    if(d < minDist){
      minDist = d;
      nearestIndex = i;
    }
  });

  // calculate remaining distance
  let remaining = 0;

  for(let i=nearestIndex+1; i<routeCoords.length; i++){
    remaining += routeCoords[i]
      .distanceTo(routeCoords[i-1]);
  }

  document.getElementById("distanceDisplay").textContent =
    "Distance: " + (remaining/1000).toFixed(2) + " km";
}

function resetAlarmSlider(){

  // turn alarm off
  if(alarmArmed){
    deactivateAlarm();  // ‚Üê THIS IS THE KEY
  }
  // stop sound if playing
  const audio = document.getElementById("alarmSound");
  audio.pause();
  audio.currentTime = 0;

  // move slider back
  const thumb = document.getElementById("sliderThumb");
  if(thumb){
    thumb.style.left = "0px";
  }

  // reset text
  const txt = document.querySelector(".slider-text");
  if(txt){
    txt.textContent = "SLIDE TO ACTIVATE ALARM";
  }

  
}


// ================= GEOFENCE =================
function checkGeofence(){

  if(!userLatLng || !alarmArmed) return;

  stops.forEach(stop=>{

    if(!stop.reached){

      const distance = userLatLng.distanceTo(stop.latlng);

      if(distance <= stop.radius){

        stop.reached = true;

        stop.circle.setStyle({color:"green"});

        triggerAlarmSound(stop.name);

      }

    }

  });
 if(finalDestination && finalCircle){



























  const d = userLatLng.distanceTo(finalDestination);

  if(d <= currentRadius){

    finalCircle.setStyle({
      color:"green",
      fillColor:"green"
    });

    // üî• TRIGGER ALARM (ONLY ONCE)
    if(!finalDestination.reached){
      finalDestination.reached = true;
      triggerAlarmSound("Destination");
    }

  } else {

    finalCircle.setStyle({
      color:"red",
      fillColor:"red"
    });
  }
}



}
function triggerAlarmSound(place){

  const audio = document.getElementById("alarmSound");

  audio.currentTime = 0;
  audio.play().catch(()=>{});


  showToast("Reached: " + place);

}



function showToast(message){

  const toast = document.getElementById("toast");

  toast.textContent = message;
  toast.classList.add("show");

  setTimeout(()=>{
    toast.classList.remove("show");
  },2000);

}







async function getCityName(lat,lng){

  try{
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
    );

    const data = await res.json();

    return (
      data.address.city ||
      data.address.town ||
      data.address.village ||
      "Stop"
    );

  }catch{
    return "Stop";
  }

}
function updateDistance(){

  if(!routeLine) return;

  const layer = routeLine.getLayers()[0];
  if(!layer) return;

  const coords = layer.getLatLngs();

  let total = 0;

  for(let i=1;i<coords.length;i++){
    total += coords[i].distanceTo(coords[i-1]);
  }

  document.getElementById("distanceDisplay").textContent =
    "Distance: " + (total/1000).toFixed(2) + " km";
}




window.addEventListener("DOMContentLoaded", () => {

  const thumb = document.getElementById("sliderThumb");
  const slider = document.querySelector(".slider-track");

  let dragging = false;
  let startX = 0;
  let currentX = 0;

  slider.addEventListener("mousedown",startDrag);
  document.addEventListener("mousemove",drag);
  document.addEventListener("mouseup",stopDrag);

  slider.addEventListener("touchstart",startDrag);
  document.addEventListener("touchmove",drag);
  document.addEventListener("touchend",stopDrag);

  function startDrag(e){
    dragging=true;
    startX = getX(e);
  }

  function drag(e){

  if(!dragging) return;

  const sliderRect = slider.getBoundingClientRect();
  const max = slider.offsetWidth - thumb.offsetWidth;

  currentX =
    getX(e) - sliderRect.left - (thumb.offsetWidth / 2);

  if(currentX < 0) currentX = 0;
  if(currentX > max) currentX = max;

  // smooth movement
  requestAnimationFrame(()=>{
    thumb.style.left = currentX + "px";
  });
}



  function stopDrag(){

  if(!dragging) return;
  dragging = false;

  const max = slider.offsetWidth - thumb.offsetWidth;

  if(currentX >= max * 0.95){

    thumb.style.left = max + "px";

    if(!alarmArmed){
      activateAlarm();
    }

  }else{

    thumb.style.left = "0px";

    if(alarmArmed){
      deactivateAlarm();
    }
  }
}



  function getX(e){
    return e.touches ? e.touches[0].clientX : e.clientX;
  }

  function activateAlarm(){

  alarmArmed = true;

  showToast("Alarm Activated");
  console.log("Alarm ON");

  checkGeofence(); // ‚Üê IMPORTANT

}

});

function deactivateAlarm(){

  alarmArmed = false;

  const audio = document.getElementById("alarmSound");
  audio.pause();
  audio.currentTime = 0;

  showToast("Alarm Off");
  console.log("Alarm OFF");

}


</script>
<audio id="alarmSound" src="ALARM.mp3" preload="auto"></audio>


<div id="toast" class="toast"></div>
<div id="guideModal" class="guide-modal">

  <div class="guide-box">

    <div class="guide-header">
    <div class="guide-title">Wake Me Up Guide ‚ú®</div>
    <button id="closeGuide">‚úï</button>
</div>

<div class="guide-content">

    <p><b>Welcome to Wake Me Up üöÄ</b><br>
    Smart location-based alarm for travelers.<br>
  Developed by <b>Mr.Arbaj Shaikh</b><br>
Senior Data Scientist & Gen AI Architect</p>


    <div class="guide-section-title">üåç Main USP</div>
    <p>
      Your alarm rings automatically when you reach your destination radius ‚Äî
      no need to keep checking maps or time while travelling.
    </p>

    <div class="guide-section-title">‚ö° How To Use</div>
    <p>‚Ä¢ Search your destination city</p>
    <p>‚Ä¢ Adjust radius (trigger alarm once you're within radius)</p>
    <p>‚Ä¢ Add multiple stops if needed (trigger alarm at each stop)</p>
    <p>‚Ä¢ Slide to activate tracking</p>

    <div class="guide-section-title">üí° Pro Tips</div>
    <p>‚Ä¢ Use radius sliders or manual adjustment for accurate wake-up</p>
    <p>‚Ä¢ Keep GPS & Application ON for best tracking</p>
    <p>‚Ä¢ Works great for long-distance travel</p>

</div>


  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const infoBtn = document.getElementById("infoBtn");
  const guide = document.getElementById("guideModal");
  const closeGuide = document.getElementById("closeGuide");
  const refreshBtn = document.getElementById("refreshBtn");
  
  refreshBtn.onclick = function(){

  const overlay =
    document.getElementById("refreshOverlay");

  // start animation
  overlay.classList.add("active");

  // reload after animation
  setTimeout(()=>{
    location.reload();
  },900);

};


  if(!infoBtn) return;



  // OPEN
  infoBtn.onclick = function(){
      guide.style.display = "flex";
  };

  // CLOSE button
  closeGuide.onclick = function(){
      guide.style.display = "none";
  };

  // click outside closes
  guide.onclick = function(e){
      if(e.target === guide){
          guide.style.display = "none";
      }
  };

});
</script>
<div id="refreshOverlay"></div>

</body>
</html>
